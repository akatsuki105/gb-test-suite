# GameBoyのCPUの命令実行時間のテスト

このROMは、HALT、STOP、11の不正なオペコードを除くすべてのCPU命令のタイミングをテストします。

`JR NC, i8`のような条件付き命令では、取られたタイミングと取られなかったタイミングをテストします。このテストには、適切なタイマー操作（TAC、TIMA、TMA）が必要です。

テストに失敗した命令は次のように表示されます。

```
[CB] opcode:measured time-correct time
```

時間は命令サイクル単位で、NOPを1サイクルとしています。

## サイクルタイムテーブル(実機と等しいことは検証済み)

このテストでは、適切なサイクルタイムのテーブルを内部で使用しており、エミュレータで使用することで適切なタイミングを確保することができます。

以下の変更点は、`.byte`接頭辞を削除し、末尾にカンマを追加しただけで、ほとんどのプログラミング言語で変更なく使用できるようになっています。

正しさを保証するために、ソースコードの最後にオリジナルのテーブルを掲載しています。

**通常の命令:**

```sh
	1,3,2,2,1,1,2,1,5,2,2,2,1,1,2,1,
	0,3,2,2,1,1,2,1,3,2,2,2,1,1,2,1,
	2,3,2,2,1,1,2,1,2,2,2,2,1,1,2,1,
	2,3,2,2,3,3,3,1,2,2,2,2,1,1,2,1,
	1,1,1,1,1,1,2,1,1,1,1,1,1,1,2,1,
	1,1,1,1,1,1,2,1,1,1,1,1,1,1,2,1,
	1,1,1,1,1,1,2,1,1,1,1,1,1,1,2,1,
	2,2,2,2,2,2,0,2,1,1,1,1,1,1,2,1,
	1,1,1,1,1,1,2,1,1,1,1,1,1,1,2,1,
	1,1,1,1,1,1,2,1,1,1,1,1,1,1,2,1,
	1,1,1,1,1,1,2,1,1,1,1,1,1,1,2,1,
	1,1,1,1,1,1,2,1,1,1,1,1,1,1,2,1,
	2,3,3,4,3,4,2,4,2,4,3,0,3,6,2,4,
	2,3,3,0,3,4,2,4,2,4,3,0,3,0,2,4,
	3,3,2,0,0,4,2,4,4,1,4,0,0,0,2,4,
	3,3,2,1,0,4,2,4,3,2,4,1,0,0,2,4
```

**CB接頭辞命令:**

```sh
	2,2,2,2,2,2,4,2,2,2,2,2,2,2,4,2,
	2,2,2,2,2,2,4,2,2,2,2,2,2,2,4,2,
	2,2,2,2,2,2,4,2,2,2,2,2,2,2,4,2,
	2,2,2,2,2,2,4,2,2,2,2,2,2,2,4,2,
	2,2,2,2,2,2,3,2,2,2,2,2,2,2,3,2,
	2,2,2,2,2,2,3,2,2,2,2,2,2,2,3,2,
	2,2,2,2,2,2,3,2,2,2,2,2,2,2,3,2,
	2,2,2,2,2,2,3,2,2,2,2,2,2,2,3,2,
	2,2,2,2,2,2,4,2,2,2,2,2,2,2,4,2,
	2,2,2,2,2,2,4,2,2,2,2,2,2,2,4,2,
	2,2,2,2,2,2,4,2,2,2,2,2,2,2,4,2,
	2,2,2,2,2,2,4,2,2,2,2,2,2,2,4,2,
	2,2,2,2,2,2,4,2,2,2,2,2,2,2,4,2,
	2,2,2,2,2,2,4,2,2,2,2,2,2,2,4,2,
	2,2,2,2,2,2,4,2,2,2,2,2,2,2,4,2,
	2,2,2,2,2,2,4,2,2,2,2,2,2,2,4,2
```


## テスト内部の処理について

Before each instruction is executed, the test sets up registers and memory in such a way that the instruction will cleanly execute and then end up at a common destination, without trashing anything important. 

The timing itself is done by first synchronizing to the timer via a loop, executing the instruction, then using a similar loop to determine how many clocks elapsed.

## エラーコード

[cpu_instrs](../cpu_instrs/README.ja.md#エラーコード)参照

## 画面出力

[cpu_instrs](../cpu_instrs/README.ja.md#画面出力)参照

## ソースコード

[cpu_instrs](../cpu_instrs/README.ja.md#ソースコード)参照

## Internal framework operation

[cpu_instrs](../cpu_instrs/README.ja.md#internal-framework-operation)参照
